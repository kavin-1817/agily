{% extends 'base.html' %}
{% load stories_tags %}

{% block page_title %}[product backlog] {{ object.title }} :: {{ current_workspace }}{% endblock %}

{% block object_list_url %}{% url 'stories:epic-list' current_workspace %}{% endblock %}

{% block content %}
	<nav class="level">
		<!-- Left side -->
		<div class="level-left">
			<nav class="breadcrumb is-large" aria-label="breadcrumbs">
				<ul>
          <li><a href="{% url 'stories:epic-list' current_workspace %}">Product Backlogs</a></li>
          <li class="is-active">
            <a href="#" aria-current="page">
              {{ object.title }}
            </a>
          </li>
				</ul>
			</nav>
		</div>

		<!-- Right side -->
		<div class="level-right">
			<div class="level-item">
        {% if product_backlog and product_backlog.id and user.is_superuser or is_project_admin %}
          <a href="{% url 'stories:epic-edit' current_workspace product_backlog.id %}" class="button is-link">
            <span class="icon is-small">
              <i class="fas fa-edit"></i>
            </span>
            <small>Edit</small>
          </a>
        {% endif %}
			</div>

			<div class="level-item">
				<div class="field has-addons">
					<p class="control">
            <form method="POST">
              {% csrf_token %}
              <button class="button is-danger is-outlined" type="submit" name="remove" value="yes">
                <span class="icon is-small">
                  <i class="fas fa-minus"></i>
                </span>
                <small>Remove</small>
              </button>
            </form>
					</p>
				</div>
			</div>

		</div>
	</nav>

	<div class="card" style="margin-bottom: 2rem; box-shadow: 0 4px 24px 0 rgba(71,85,105,0.10);">
  <div class="card-content" style="background: #f8fafc; border-radius: 12px;">
    <div style="max-width: 700px; width: 100%; display: flex; flex-direction: column; gap: 1.2em; align-items: flex-start;">
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-heading"></i></span> Title
        </div>
        <div style="margin-left: 0.5em;">: {{ object.title }}</div>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-project-diagram"></i></span> Project
        </div>
        <div style="margin-left: 0.5em;">: {{ object.project|default:"No project assigned" }}</div>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-user"></i></span> Owner
        </div>
        <div style="margin-left: 0.5em;">: {{ object.owner }}</div>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-flag"></i></span> Status
        </div>
        <div style="margin-left: 0.5em;">: <span class="tag is-info is-light" style="font-size:1em;">{{ object.state }}</span></div>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-exclamation-triangle"></i></span> Priority
        </div>
        <div style="margin-left: 0.5em;">: 
          {% if object.priority == 'high' %}
            <span class="tag is-danger is-light" style="font-size:1em;">High</span>
          {% elif object.priority == 'medium' %}
            <span class="tag is-warning is-light" style="font-size:1em;">Medium</span>
          {% else %}
            <span class="tag is-success is-light" style="font-size:1em;">Low</span>
          {% endif %}
        </div>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-tags"></i></span> Tags
        </div>
        <div style="margin-left: 0.5em;">: {% for tag in object.tags.all %}<span class="tag is-light">{{ tag.name }}</span> {% empty %}<span class="has-text-grey">No tags</span>{% endfor %}</div>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="min-width: 160px; font-weight:bold; color:#000;">
          <span class="icon"><i class="fas fa-clock"></i></span> Last Update
        </div>
        <div style="margin-left: 0.5em;">: <time datetime="{{ object.updated_at }}">{{ object.updated_at }}</time></div>
      </div>
      <div style="display: flex; align-items: flex-start; margin-top: 1.5em;">
        <div style="min-width: 160px; font-weight:bold; color:#000; margin-top: 0.3em;">
          <span class="icon"><i class="fas fa-align-left"></i></span> Description
        </div>
        <div style="margin-left: 0.5em; flex: 1; display: flex; align-items: flex-start;">
          <span style="margin-right: 0.5em;">:</span>
          <div class="content" style="background: #fff; border-radius: 8px; padding: 1em 1.2em; border: 1px solid #e5e7eb; min-height: 60px; width: 100%;  word-break: break-word;min-width: 600px;">
            {{ object.description|default:'' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <br/>
  <form method="POST" id="object-list">
	{% csrf_token %}
	<nav class="level">
		<!-- Left side -->
		<div class="level-left">
			<nav class="breadcrumb is-large" aria-label="breadcrumbs" style="margin: 0; padding: 0;">
				<ul>
					<li class="is-active"><a href="#" aria-current="page">Stories</a></li>
				</ul>
			</nav>

			<div class="level-item">
			{% for field in group_by_form.visible_fields %}
			  <div class="level-item">
				<label>{{ field.label }}</label>&nbsp;
				<div class="field">
				  {{ field }}
				</div>
			  </div>
			{% endfor %}
			</div>
		</div>

		<!-- Right side -->
		<div class="level-right">
      {% for field in filters_form.visible_fields %}
        <div class="level-item bulk-action">
          <div class="field">
            <div class="control">
              <div class="select is-primary">
                {{ field }}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
			<div class="level-item bulk-action">
				<div class="field has-addons">
					<p class="control">
            <button class="button is-danger is-outlined" form="object-list" type="submit" value="yes" name="epic-reset" value="yes">
              <span class="icon is-small">
                <i class="fas fa-minus"></i>
              </span>
              <small>Remove from Epic</small>
						</button>
					</p>
				</div>
			</div>

			<div class="level-item">
				<div class="field has-addons">
					<p class="control">
            <a class="button is-link" href="{% url 'stories:story-add' current_workspace %}?next={{ encoded_url }}&amp;epic={{ product_backlog.id }}">
              <span class="icon is-small">
                <i class="fas fa-plus"></i>
              </span>
              <small>Create</small>
						</a>
					</p>
				</div>
			</div>

     
	</nav>

    {% csrf_token %}
    {% for group_title, object_list in objects_by_group %}
      {% if group_by %}
        <h3 class="subtitle">{{ group_title }}</h3>
      {% endif %}

			<table class="table is-bordered is-striped is-hoverable is-fullwidth">
				<thead>
					<tr>
					<th>
                	<input type="checkbox" class="selectAll" />
            		</th>
						<th>ID</th>
						<th>Title</th>
						<th>State</th>
						<th>Priority</th>
						<th>Pts</th>
						<th>Requester</th>
						<th>Assignee</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for story in object_list %}
					<tr {% if story.is_done %}class="has-text-grey-dark"{% endif %}>
						<td>
							<div class="field">
							  <input type="checkbox" name="story-{{ story.id }}" />
							</div>
						  </td>
						<td>#{{ story.id }}</td>
						<td>
							<a href="{% url 'stories:story-detail' current_workspace story.id %}?next={{ encoded_url }}" {% if story.is_done %}class="has-text-grey-dark"{% endif %}>
								<strong>{{ story.title }}</strong><br/>
							</a>
							{% for tag in story.tags.all %}
							<span class="tag is-light">{{ tag.name }}</span>
							{% endfor %}
						</td>
						<td>{{ story.state }}</td>
						<td>{{ story.priority }}</td>
						<td>{{ story.points }}</td>
						<td>{{ story.requester.username }}</td>
						<td>{{ story.assignee.username }}</td>
						<td>
							<a class="button is-small is-link is-outlined" href="{% url 'stories:story-edit' current_workspace story.id %}?next={{ encoded_url }}" title="Edit">
								<span class="icon is-small">
									<i class="fas fa-edit"></i>
								</span>
								<small>edit</small>
							</a>
						</td>
						
					</tr>
					{% endfor %}
				</tbody>
			</table>
		{% endfor %}
  </form>

{% endblock %}
