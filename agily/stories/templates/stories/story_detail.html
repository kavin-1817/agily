{% extends 'base.html' %}
{% load stories_tags %}

{% block page_title %}[Story] {{ object.title }} :: {{ current_workspace }}{% endblock %}

{% block object_list_url %}{% url 'stories:story-list' current_workspace %}{% endblock %}

{% block content %}
	<nav class="level">
		<!-- Left side -->
		<div class="level-left">
			<nav class="breadcrumb is-large" aria-label="breadcrumbs">
				<ul>
          <li><a href="{% url 'stories:story-list' current_workspace %}">Stories</a></li>
          <li class="is-active">
            <a href="{% url 'stories:story-detail' current_workspace object.id %}" aria-current="page">
              {{ object.title }}
            </a>
          </li>
				</ul>
			</nav>
		</div>

		<!-- Right side -->
		<div class="level-right">
			<div class="level-item">
        <a href="{% url 'stories:story-edit' current_workspace object.id %}?next={{ encoded_url }}" class="button is-link">
          <span class="icon is-small">
            <i class="fas fa-edit"></i>
          </span>
          <small>Edit</small>
				</a>
			</div>

			<div class="level-item">
				<div class="field has-addons">
					<p class="control">
            <form method="POST">
              {% csrf_token %}
              <button class="button is-danger is-outlined" type="submit" name="remove" value="yes"
                      onclick="postForm(this.form, this); return false;">
                <span class="icon is-small">
                  <i class="fas fa-minus"></i>
                </span>
                <small>Remove</small>
              </button>
            </form>
					</p>
				</div>
			</div>

		</div>
	</nav>

	<div class="card">
		<div class="card-content">
			<div class="media">
				<div class="media-content">
					<p class="subtitle is-6">
						<a href="{{ object.product_backlog.get_absolute_url }}" title="Product Backlog">
							<span class="icon is-small">
								<i class="fas fa-bookmark" aria-hidden="true"></i>
							</span>
							<span>{{ object.product_backlog.title }}</span> <!-- Product Backlog -->
						</a> - @{{ object.requester }} {% if object.assignee %}- assigned to {{ object.assignee }}{% endif %}
					</p>
				</div>
			</div>

			<div class="content">
				{{ object.description|default:''|to_html }}<br/><br/>
				<div class="field is-grouped is-grouped-multiline">
					<div class="control">
						<div class="tags has-addons">
							<span class="tag">State</span>
							<span class="tag is-primary">{{ object.state }}</span>
						</div>
					</div>
					<div class="control">
						<div class="tags has-addons">
							<span class="tag">Priority</span>
							<span class="tag is-link">{{ object.priority }}</span>
						</div>
					</div>
					{% for tag in object.product_backlog.tags.all %}
					<div class="control">
						<div class="tags has-addons">
							<span class="tag is-dark">#</span>
							<span class="tag is-light">{{ tag.name }}</span>
						</div>
					</div>
					{% endfor %}
				</div>
				<strong>Last Update:</strong> <time datetime="{{ object.updated_at }}">{{ object.updated_at }}</time>
			</div>
			<!-- Attachments inside the card -->
			<div class="attachments-section">
				<div class="level">
					<div class="level-left">
						<h3 class="title is-5">
							<span class="icon is-small">
								<i class="fas fa-paperclip"></i>
							</span>
							Attachments ({{ object.attachments.count }})
						</h3>
					</div>
					<div class="level-right">
						<a href="{% url 'stories:story-attachment-upload' object.workspace.slug object.id %}" class="button is-primary is-small">
							<span class="icon is-small">
								<i class="fas fa-upload"></i>
							</span>
							<span>Upload Attachment</span>
						</a>
					</div>
				</div>
				{% if object.attachments.all %}
				<div class="table-container">
					<table class="table is-fullwidth is-striped is-hoverable">
						<thead>
							<tr>
								<th style="width: 40%;">File</th>
								<th style="width: 15%;">Size</th>
								<th style="width: 20%;">Uploaded</th>
								<th style="width: 25%;">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for attachment in object.attachments.all %}
							<tr>
								<td>
									<div class="media">
										<div class="media-left">
											<span class="icon is-small">
												<i class="fas fa-file"></i>
											</span>
										</div>
										<div class="media-content">
											<div>
												<a href="{% url 'stories:story-attachment-download' object.workspace.slug attachment.pk %}?v={{ attachment.uploaded_at.timestamp }}" 
												   download 
												   onclick="event.preventDefault(); forceDownload(this.href, '{{ attachment.filename }}');"
												   class="has-text-link">
													{{ attachment.filename }}
												</a>
											</div>
													{% if attachment.description %}
													<div class="has-text-grey is-size-7">
														{{ attachment.description }}
													</div>
													{% endif %}
										</div>
									</div>
								</td>
								<td>
									<span class="has-text-grey">{{ attachment.file.size|filesizeformat }}</span>
								</td>
								<td>
									<span class="has-text-grey is-size-7">
										<time datetime="{{ attachment.uploaded_at }}">{{ attachment.uploaded_at|date:"M j, Y" }}</time>
									</span>
								</td>
								<td>
									<div class="buttons are-small">
										<form method="post" action="{% url 'stories:story-attachment-delete' workspace=current_workspace pk=attachment.pk %}" style="display:inline;">
											{% csrf_token %}
											<button type="submit" class="button is-danger is-small" 
													onclick="return confirm('Are you sure you want to delete this attachment?')">
												<span class="icon is-small">
													<i class="fas fa-trash"></i>
												</span>
												<span>Delete</span>
											</button>
										</form>
									</div>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="notification is-light">
					<p class="has-text-grey">
						<span class="icon is-small">
							<i class="fas fa-info-circle"></i>
						</span>
						No attachments uploaded yet.
					</p>
				</div>
				{% endif %}
			</div>
		</div>
	</div>

<script>
function forceDownload(url, filename) {
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}
