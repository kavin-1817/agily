{% extends 'base.html' %}
{% load text_extras %}

{% block page_title %}Issues{% endblock %}

{% block content %}
  <div class="container">
    <div class="section">
      <div class="level" style="margin-bottom: 1em;">
        <div class="level-left">
          <h2 class="title" style="margin-right: 1.5em;">Issues</h2>
          <form method="get" class="level-item" style="margin-bottom: 0; display: flex; align-items: center; gap: 0.5em;">
            <input class="input" type="text" name="q" placeholder="Search..." value="{{ request.GET.q }}" style="max-width: 200px; font-size: 0.98em; padding: 0.3em 0.7em;">
            <button class="button is-link" id="search-button" type="submit" style="padding: 0.3em 0.9em; font-size: 0.98em;">
              <span class="icon is-small">
                <i class="fas fa-search"></i>
              </span>
              <small>Search</small>
            </button>
          </form>
          <span class="tag is-info is-medium level-item" style="margin-left: 1em; align-self: center;">Total: {{ paginator.count }}</span>
        </div>
        <div class="level-right">
          <form method="get" class="level-item" style="margin-right: 1em; display: flex; align-items: center; gap: 0.5em;">
            <label for="project-filter" style="font-weight: 600; margin-bottom: 0; font-size: 0.98em;">Project:</label>
            <div class="select" style="max-width: 120px; font-size: 0.98em;">
              <select name="project" id="project-filter" style="min-width: 80px; font-size: 0.98em; padding: 0.3em 0.7em;">
                <option value="">All</option>
                {% for project in projects %}
                  <option value="{{ project.id }}" {% if project.id|stringformat:'s' == selected_project_id|stringformat:'s' %}selected{% endif %}>{{ project.name }}</option>
                {% endfor %}
              </select>
            </div>
            <label for="assignee-filter" style="font-weight: 600; margin-bottom: 0; font-size: 0.98em;">Assignee:</label>
            <div class="select" style="max-width: 120px; font-size: 0.98em;">
              <select name="assignee" id="assignee-filter" style="min-width: 80px; font-size: 0.98em; padding: 0.3em 0.7em;">
                <option value="">All</option>
                {% for assignee in assignees %}
                  <option value="{{ assignee.id }}" {% if assignee.id|stringformat:'s' == selected_assignee_id|stringformat:'s' %}selected{% endif %}>
                    {{ assignee.name|default:assignee.username }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="button is-link" style="padding: 0.3em 0.9em; font-size: 0.98em;">Filter</button>
          </form>
          {% if is_tester or is_project_admin or user.is_superuser %}
          <!-- Export Button -->
          <a class="button is-success" href="{% if current_workspace %}{% url 'workspace-issue-export' current_workspace %}{% else %}{% url 'global-issue-export' %}{% endif %}" style="margin-left: 0.5em;" data-hx-boost="false" data-hx-ignore="true">
            <span class="icon is-small"><i class="fas fa-file-export"></i></span>
            <small>Export</small>
          </a>
          
          <!-- Import Button -->
          <a class="button is-info" href="{% if current_workspace %}{% url 'workspace-issue-import' current_workspace %}{% else %}{% url 'global-issue-import' %}{% endif %}" style="margin-left: 0.5em;">
            <span class="icon is-small"><i class="fas fa-file-import"></i></span>
            <small>Import</small>
          </a>
          {% endif %}
          {% if is_tester or is_project_admin or user.is_superuser %}
            <a class="button is-primary" href="{% if current_workspace %}{% url 'workspace-issue-add' current_workspace %}{% else %}{% url 'global-issue-add' %}{% endif %}" style="margin-left: 1em;">
              <span class="icon is-small"><i class="fas fa-plus"></i></span>
              <small>Add Issue</small>
            </a>
          {% endif %}
        </div>
      </div>
      <table class="table issue-table is-bordered is-striped is-hoverable is-fullwidth">
        <thead>
          <tr>
            <th class="id-cell">ID</th>
            <th>Title</th>
            <th>Status</th>
            <th>Severity</th>
            <th>Requester</th>
            <th>Assignee</th>
            <th>Last Update</th>
  
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for issue in object_list %}
          <tr>
            <td class="id-cell">{{ issue.id }}</td>
            <td class="title">
              <a href="{% if current_workspace %}{% url 'workspace-issue-detail' current_workspace issue.pk %}{% else %}{% url 'global-issue-detail' pk=issue.pk %}{% endif %}">
                <b>{{ issue.title|truncate_title:45 }}</b>
              </a>
            </td>
            <td>{{ issue.get_status_display }}</td>
            <td>{{ issue.get_severity_display }}</td>
            <td>{{ issue.requester }}</td>
            <td>{{ issue.assignee }}</td>
            <td>{{ issue.created_at|date:'Y-m-d' }}</td>
           
            <td class="actions">
              <a href="{% if current_workspace %}{% url 'workspace-issue-detail' current_workspace issue.pk %}{% else %}{% url 'global-issue-detail' pk=issue.pk %}{% endif %}" title="View" style="width:2.5em; height:2.5em; background:#8FA01F !important; color:white !important; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; margin-right:0.3em; text-decoration:none;"><i class='fas fa-eye' style='color:white;'></i></a>
              {% if is_developer or is_project_admin or user.is_superuser %}
                <a href="{% if current_workspace %}{% url 'workspace-issue-edit' current_workspace issue.pk %}{% else %}{% url 'global-issue-edit' pk=issue.pk %}{% endif %}?next={{ encoded_url }}" title="Edit" style="width:2.5em; height:2.5em; background:#1B4F72; color:white; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; margin-right:0.3em; text-decoration:none;"><i class='fas fa-edit' style='color:white;'></i></a>
                <form method="post" action="{% if current_workspace %}{% url 'workspace-issue-delete' current_workspace issue.pk %}{% else %}{% url 'global-issue-delete' issue.pk %}{% endif %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" name="remove" value="yes" title="Remove" onclick="return confirm('Are you sure you want to remove this issue?');" style="width:2.5em; height:2.5em; background:#943126; color:white; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; padding:0;"><i class='fas fa-trash' style='color:white;'></i></button>
                </form>
              {% elif is_tester and issue.requester == user %}
                <!-- Testers can only edit/delete issues they created -->
                <a href="{% if current_workspace %}{% url 'workspace-issue-edit' current_workspace issue.pk %}{% else %}{% url 'global-issue-edit' pk=issue.pk %}{% endif %}?next={{ encoded_url }}" title="Edit" style="width:2.5em; height:2.5em; background:#1B4F72; color:white; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; margin-right:0.3em; text-decoration:none;"><i class='fas fa-edit' style='color:white;'></i></a>
                <form method="post" action="{% if current_workspace %}{% url 'workspace-issue-delete' current_workspace issue.pk %}{% else %}{% url 'global-issue-delete' issue.pk %}{% endif %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" name="remove" value="yes" title="Remove" onclick="return confirm('Are you sure you want to remove this issue?');" style="width:2.5em; height:2.5em; background:#943126; color:white; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; padding:0;"><i class='fas fa-trash' style='color:white;'></i></button>
                </form>
              {% elif is_tester and issue.requester != user %}
                <!-- Testers cannot edit/delete issues created by others - show disabled buttons with tooltip -->
                <button onclick="showPermissionMessage('You can only edit/delete issues you created. This issue was created by {{ issue.requester }}.')" title="You can only edit/delete issues you created" style="width:2.5em; height:2.5em; background:#cccccc; color:#666; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; margin-right:0.3em; cursor:not-allowed;"><i class='fas fa-edit' style='color:#666;'></i></button>
                <button onclick="showPermissionMessage('You can only edit/delete issues you created. This issue was created by {{ issue.requester }}.')" title="You can only edit/delete issues you created" style="width:2.5em; height:2.5em; background:#cccccc; color:#666; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; border:none; cursor:not-allowed;"><i class='fas fa-trash' style='color:#666;'></i></button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9">No issues found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <br/>
      {% include "paginator.html" %}
    </div>
  </div>
  <script>
    function convertAllDateTimes() {
      document.querySelectorAll('.datetime-local').forEach(function(el) {
        var utc = el.getAttribute('data-utc');
        if (utc) {
          var local = new Date(utc);
          el.textContent = local.toLocaleString();
        }
      });
    }
    
    // Function to show permission restriction message
    function showPermissionMessage(message) {
      // Create a custom alert/modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      `;
      
      content.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <i class="fas fa-exclamation-triangle" style="color: #f39c12; font-size: 2rem;"></i>
        </div>
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">Permission Restricted</h3>
        <p style="color: #34495e; margin-bottom: 1.5rem;">${message}</p>
        <button onclick="this.closest('.permission-modal').remove()" style="
          background: #8FA01F;
          color: white;
          border: none;
          padding: 0.7em 1.5em;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
        ">OK</button>
      `;
      
      modal.className = 'permission-modal';
      modal.appendChild(content);
      document.body.appendChild(modal);
    }
    
    document.addEventListener('DOMContentLoaded', convertAllDateTimes);
    // For htmx navigation (if used)
    if (window.htmx) {
      document.body.addEventListener('htmx:afterSwap', convertAllDateTimes);
    }
  </script>
{% endblock %}